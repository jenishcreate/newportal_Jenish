@{
    ViewData["Title"] = "Recharge Transactions";
}
<form id="csrfForm">@Html.AntiForgeryToken()</form>

<style>
    #retailerTable thead th {
        border-bottom: 2px solid #616161 !important;
        color: #212121;
        font-weight: 700;
        font-size: 13px;
        text-transform: uppercase;
    }

    #retailerTable td {
        background-color: #ffffff;
        vertical-align: middle;
        font-size: 15px;
        color: #212121;
    }

        #retailerTable td:first-child {
            font-weight: 600;
            text-align: center;
        }

    div.dataTables_filter {
        margin-top: 0.75rem;
        margin-bottom: 1rem;
    }

    #retailerTable td, #retailerTable th {
        padding: 0.6rem 1rem !important;
        vertical-align: middle;
    }

    .dt-actions {
        display: flex;
        flex-wrap: nowrap;
        gap: 0.25rem;
    }

    .highlight-text {
        color: #0d47a1;
        font-weight: 600;
    }

    #loadingIndicator .spinner-border {
        width: 3rem;
        height: 3rem;
    }
</style>

<div class="container-fluid px-3 mt-3">
    <h2 class="mb-3 text-center mt-3">All Recharge Transactions</h2>

    <!-- 📅 Date Range Filter -->
    <div class="row mb-4">
        <div class="col-md-3">
            <label for="startDate" class="form-label highlight-text">Start Date:</label>
            <input type="date" id="startDate" class="form-control" />
        </div>
        <div class="col-md-3">
            <label for="endDate" class="form-label highlight-text">End Date:</label>
            <input type="date" id="endDate" class="form-control" />
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button id="loadBtn" class="btn btn-primary w-100">Submit</button>
        </div>
    </div>



    <div class="row d-flex mb-3">
        <span class="highlight-text">Please select a date range</span>
    </div>
    <!-- 🔄 Loading Indicator -->
    <div id="loadingIndicator" class="text-center mb-3" style="display:none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 highlight-text">Loading transactions...</p>
    </div>
    <div class="table-responsive">
        <table id="retailerTable" class="table table-sm table-bordered align-middle table-hover" style="width:100%">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Txn ID</th>
                    <th>User</th>
                    <th>Mobile No</th>
                    <th>Operator</th>
                    <th>Status</th>
                    <th>Circle</th>
                    <th>Recharge Type</th>
                    <th>Recharge Amount</th>
                    <th>Debited Amount</th>
                    <th>Last Balance</th>
                    <th>Date</th>
                </tr>
            </thead>
        </table>
    </div>
</div>


@section Scripts {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <script>
        let dataTable;
        let token;

        $(document).ready(function () {
            token = $('input[name="__RequestVerificationToken"]').val();

            // Set default date as today
            const today = new Date().toISOString().split('T')[0];
            $('#startDate').val(today);
            $('#endDate').val(today);

            // Initialize DataTable
            dataTable = $('#retailerTable').DataTable({
                "ajax": {
                    "url": "/Retailer/Report/RechargeTransactionJson",
                    "type": "POST",
                    "datatype": "json",
                    "headers": {
                        "RequestVerificationToken": token
                    },
                    "data": function (d) {
                        d.startDate = $('#startDate').val();
                        d.endDate = $('#endDate').val();
                    },
                    "dataSrc": function (json) {
                        return json.data;
                    },
                    "error": function (xhr) {
                        console.error("❌ AJAX error:", xhr.responseText);
                    }
                },
                "columns": [
                    {
                        "data": null,
                        "render": function (data, type, row, meta) {
                            return meta.row + 1;
                        },
                        "orderable": false
                    },
                    { data: 'recharge_transaction_id' },
                    { data: 'initiated_UserName' },
                    { data: 'customer_MobileNumber' },
                        {
            data: 'mobileNumber_operator',
                render: function (data) {
            let style = '';
            if ( data === 'Jio') {
                style = 'background-color: #00008B; color: white;'; // dark bule
            } else if (data === 'Airtel') {
                style = 'background-color: #dc3545; color: white;'; // red
            } else if (data === 'Vi') {
                style = 'background-color: #ffc107; color: black;'; // yellow
            }else if (data === 'BSNL') {
                style = 'background-color: #007bff; color: white;'; // Manual blue
            }
            return `<span class="badge" style="${style}">${data}</span>`;
        }
        },
        {
            data: 'status',
            render: function (data) {
                let color = '';
                if (data === 'Initiated') {
                    color = 'bg-warning text-dark'; // yellow
                } else if (data === 'Failed') {
                    color = 'bg-danger text-white'; // red
                } else if (data === 'Success') {
                    color = 'bg-success text-white'; // green
                }
                return `<span class="badge ${color}">${data}</span>`;
            }
        },
                    { data: 'circle' },
                    { data: 'rechargeType' ,
                    render: function (data) {
            let style = '';
            if (data === 'Postpaid' || data === 'Postpaid') {
                style = 'background-color: #dc3545; color: white;'; // Red
            } else if (data === 'Prepaid') {
                style = 'background-color: #007bff; color: white;'; // Yellow
            } 
            return `<span class="badge" style="${style}">${data}</span>`;
            }},
                           {
            data: 'rechargeAmount',
            render: function (data) {
                return `<span style="background-color: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; display: inline-block;">₹${data}</span>`;
            }
        },

                    { data: 'debited_Amount',
            render: function (data) {
                return `<span style="background-color: #fbd9d3; color: #900000; padding: 4px 8px; border-radius: 4px; display: inline-block;">₹${data}</span>`;
            } },
                    { data: 'last_updatedbalance' },
                
                {
                    data: 'transactionDate',
                    render: function (data) {
                        const date = new Date(data);
                        return date.toLocaleString();
                    }
                }
            ],
                "language": {
                    "emptyTable": "No transactions available in selected range."
                },
                "responsive": true,
                "drawCallback": function () {
                    $('#loadingIndicator').hide(); // Hide loader after data loads
                }
            });

            // Handle submit click
            $('#loadBtn').on('click', function () {
                const startDate = $('#startDate').val();
                const endDate = $('#endDate').val();

                if (!startDate || !endDate) {
                    alert("Please select both start and end dates.");
                    return;
                }

                $('#loadingIndicator').show(); // Show loader
                dataTable.ajax.reload(null, false); // Reload DataTable
            });
        });
    </script>
}
